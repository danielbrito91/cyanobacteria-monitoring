schema: '2.0'
stages:
  data_load:
    cmd: python src/stages/data_load.py --config=params.yaml
    deps:
    - path: src/stages/data_load.py
      md5: f38968c7ccba86ab8323c4572213b1ce
      size: 1067
    params:
      params.yaml:
        base:
          random_state: 42
          log_level: INFO
        data_load:
          s2a_df: data/raw/gee.csv
          labels_download: data/raw/controle_mensal_demais_parametros.zip
          labels_df: data/raw/vigi.csv
          labeled_df: data/raw/labeled_data.csv
    outs:
    - path: data/raw/gee.csv
      md5: f0a7c3e9f7bbfb32a3b9153e8c8911ed
      size: 579647
    - path: data/raw/vigi.csv
      md5: 8392e8b0a441178b1c2f442aca8b2f44
      size: 1528947
  data_label:
    cmd: python src/stages/data_label.py --config=params.yaml
    deps:
    - path: data/raw/gee.csv
      md5: f0a7c3e9f7bbfb32a3b9153e8c8911ed
      size: 579647
    - path: data/raw/vigi.csv
      md5: 8392e8b0a441178b1c2f442aca8b2f44
      size: 1528947
    - path: src/stages/data_label.py
      md5: 38c68645f6829f4e942095e55dba2136
      size: 1466
    params:
      params.yaml:
        base:
          random_state: 42
          log_level: INFO
        data_create:
          buffer_metros: 75
          delta_dias: 2
          latitude: -30.012175
          longitude: -51.215679
          nome_eta: MOINHOS DE VENTO
          municipio: PORTO ALEGRE
          manancial: GUAIBA
          url: https://sage.saude.gov.br/dados/sisagua/controle_mensal_demais_parametros.zip
        data_load:
          s2a_df: data/raw/gee.csv
          labels_download: data/raw/controle_mensal_demais_parametros.zip
          labels_df: data/raw/vigi.csv
          labeled_df: data/raw/labeled_data.csv
        featurize:
          target_column: Resultado
          selected_clean_columns:
          - date
          - NDVI_median
          - NDCI_median
          - B1_median
          - B2_median
          - B3_median
          - B4_median
          - B5_median
          - B6_median
          - B7_median
          - B8_median
          - B8A_median
          - B9_median
          - B11_median
          - B12_median
          selected_features:
          - B3_B4
          - NDVI_median
          - B5_B4
          - NDCI_median
          - B5B3_B2
          - B5_B2
          poly_degree: 3
    outs:
    - path: data/raw/labeled_data.csv
      md5: 1f11a8310a855e557bc502279a98ce8c
      size: 11211
  data_split:
    cmd: python src/stages/data_split.py --config=params.yaml
    deps:
    - path: data/raw/labeled_data.csv
      md5: 1f11a8310a855e557bc502279a98ce8c
      size: 11211
    - path: src/data/preprocess.py
      md5: 4dfb85ec88e02610811f3dabea0280d0
      size: 1542
    - path: src/stages/data_split.py
      md5: c12cd95a9a7c591e4d35ef6a6cf5d269
      size: 1130
    params:
      params.yaml:
        base:
          random_state: 42
          log_level: INFO
        data_load:
          s2a_df: data/raw/gee.csv
          labels_download: data/raw/controle_mensal_demais_parametros.zip
          labels_df: data/raw/vigi.csv
          labeled_df: data/raw/labeled_data.csv
        data_split:
          trainset_path: data/processed/train.csv
          testset_path: data/processed/test.csv
          years_split_test: 1
        featurize:
          target_column: Resultado
          selected_clean_columns:
          - date
          - NDVI_median
          - NDCI_median
          - B1_median
          - B2_median
          - B3_median
          - B4_median
          - B5_median
          - B6_median
          - B7_median
          - B8_median
          - B8A_median
          - B9_median
          - B11_median
          - B12_median
          selected_features:
          - B3_B4
          - NDVI_median
          - B5_B4
          - NDCI_median
          - B5B3_B2
          - B5_B2
          poly_degree: 3
    outs:
    - path: data/processed/test.csv
      md5: 27ec3e3c2b3e61da14b5befb6c025466
      size: 6371
    - path: data/processed/train.csv
      md5: 8cc02f7fa3b9eea39e5011c7a9a32af3
      size: 11729
  train:
    cmd: python src/stages/train.py --config=params.yaml
    deps:
    - path: data/processed/test.csv
      md5: 27ec3e3c2b3e61da14b5befb6c025466
      size: 6371
    - path: data/processed/train.csv
      md5: 8cc02f7fa3b9eea39e5011c7a9a32af3
      size: 11729
    - path: src/stages/train.py
      md5: 64a311f3256bd3d4015753d83ff5f635
      size: 2091
    - path: src/train/train_model.py
      md5: c895dab84473d82f489661d539317caf
      size: 5738
    params:
      params.yaml:
        base:
          random_state: 42
          log_level: INFO
        data_split:
          trainset_path: data/processed/train.csv
          testset_path: data/processed/test.csv
          years_split_test: 1
        featurize:
          target_column: Resultado
          selected_clean_columns:
          - date
          - NDVI_median
          - NDCI_median
          - B1_median
          - B2_median
          - B3_median
          - B4_median
          - B5_median
          - B6_median
          - B7_median
          - B8_median
          - B8A_median
          - B9_median
          - B11_median
          - B12_median
          selected_features:
          - B3_B4
          - NDVI_median
          - B5_B4
          - NDCI_median
          - B5B3_B2
          - B5_B2
          poly_degree: 3
        mlflow_config:
          experiment_name: baselines
        train:
          estimator_name: ridge
          estimators:
            ridge:
              params:
                alpha: 30
            xgboost:
              params:
                n_estimators: 1000
                learning_rate: 0.5
                max_depth: 16
                subsample: 0.8
                colsample_bytree: 0.9
                colsample_bylevel: 0.4
                scale_pos_weight: 85
            random_forest:
              params:
                max_features: sqrt
                min_samples_leaf: 1
                n_estimators: 615
                criterion: absolute_error
          model_path: models/model.joblib
          full_model_path: models/full_model.joblib
    outs:
    - path: models/model.joblib
      md5: 79e962d642f9e0b8eb255811f4442120
      size: 8034
  evaluate:
    cmd: python src/stages/evaluate.py --config=params.yaml
    deps:
    - path: data/processed/test.csv
      md5: 76e9d9e241c2f7ca4d01e32799dcbe9c
      size: 4039
    - path: models/model.joblib
      md5: c9a448abd901b8b8d13aee39dc4c0b42
      size: 2972
    - path: src/stages/evaluate.py
      md5: 7dcc283a090a6780e2eccafb5e0aabea
      size: 3086
    params:
      params.yaml:
        base:
          random_state: 42
          log_level: INFO
        data_split:
          trainset_path: data/processed/train.csv
          testset_path: data/processed/test.csv
          years_split_test: 1
        evaluate:
          metrics_file: reports/metrics.json
          metrics_data: reports/metrics.csv
          predicted_vs_fitted_plot: reports/predicted_vs_fitted_plot.png
          final_predictions_file: data/predictions/predicted.csv
        featurize:
          target_column: Resultado
          selected_clean_columns:
          - date
          - NDVI_median
          - NDCI_median
          - B1_median
          - B2_median
          - B3_median
          - B4_median
          - B5_median
          - B6_median
          - B7_median
          - B8_median
          - B8A_median
          - B9_median
          - B11_median
          - B12_median
          selected_features:
          - B3_B4
          - NDVI_median
          - B5_B4
          - NDCI_median
          - B5B3_B2
          - B5_B2
          poly_degree: 3
        train:
          estimator_name: ridge
          estimators:
            ridge:
              params:
                alpha: 3
            xgboost:
              params:
                n_estimators: 1000
                learning_rate: 0.5
                max_depth: 16
                subsample: 0.8
                colsample_bytree: 0.9
                colsample_bylevel: 0.4
                scale_pos_weight: 85
            random_forest:
              params:
                max_features: sqrt
                min_samples_leaf: 1
                n_estimators: 615
                criterion: absolute_error
          model_path: models/model.joblib
          full_model_path: models/full_model.joblib
    outs:
    - path: reports/metrics.csv
      md5: da753a7b5037cbad4db3d29e2f345353
      size: 1185
    - path: reports/metrics.json
      md5: f0c652e89fa98a5abfc265f8f4f6fc85
      size: 25
    - path: reports/predicted_vs_fitted_plot.png
      md5: 257bbceafd119400955b4139c6f022a8
      size: 32038
  train_full_data:
    cmd: python src/stages/train_full_data.py --config=params.yaml
    deps:
    - path: data/raw/labeled_data.csv
      md5: 1f11a8310a855e557bc502279a98ce8c
      size: 11211
    - path: models/model.joblib
      md5: 79e962d642f9e0b8eb255811f4442120
      size: 8034
    - path: src/stages/train_full_data.py
      md5: 14c7cc5ad2c446a2bada33ec4377e003
      size: 1768
    params:
      params.yaml:
        base:
          random_state: 42
          log_level: INFO
        data_load:
          s2a_df: data/raw/gee.csv
          labels_download: data/raw/controle_mensal_demais_parametros.zip
          labels_df: data/raw/vigi.csv
          labeled_df: data/raw/labeled_data.csv
        featurize:
          target_column: Resultado
          selected_clean_columns:
          - date
          - NDVI_median
          - NDCI_median
          - B1_median
          - B2_median
          - B3_median
          - B4_median
          - B5_median
          - B6_median
          - B7_median
          - B8_median
          - B8A_median
          - B9_median
          - B11_median
          - B12_median
          selected_features:
          - B3_B4
          - NDVI_median
          - B5_B4
          - NDCI_median
          - B5B3_B2
          - B5_B2
          poly_degree: 3
        mlflow_config:
          experiment_name: baselines
        train:
          estimator_name: ridge
          estimators:
            ridge:
              params:
                alpha: 30
            xgboost:
              params:
                n_estimators: 1000
                learning_rate: 0.5
                max_depth: 16
                subsample: 0.8
                colsample_bytree: 0.9
                colsample_bylevel: 0.4
                scale_pos_weight: 85
            random_forest:
              params:
                max_features: sqrt
                min_samples_leaf: 1
                n_estimators: 615
                criterion: absolute_error
          model_path: models/model.joblib
          full_model_path: models/full_model.joblib
    outs:
    - path: models/full_model.joblib
      md5: d546dc086827794ad9cba64aadd5d7dd
      size: 3080
    - path: reports/metrics.json
      md5: df0d6b22a4f980248bc123e6d0becd2a
      size: 63
  predictions:
    cmd: python src/stages/predictions.py --config=params.yaml
    deps:
    - path: data/raw/gee.csv
      md5: f0a7c3e9f7bbfb32a3b9153e8c8911ed
      size: 579647
    - path: models/full_model.joblib
      md5: d546dc086827794ad9cba64aadd5d7dd
      size: 3080
    - path: src/stages/predictions.py
      md5: 511b2172e22089df0eaa3d86cfd2ab5c
      size: 1435
    params:
      params.yaml:
        base:
          random_state: 42
          log_level: INFO
        data_load:
          s2a_df: data/raw/gee.csv
          labels_download: data/raw/controle_mensal_demais_parametros.zip
          labels_df: data/raw/vigi.csv
          labeled_df: data/raw/labeled_data.csv
        featurize:
          target_column: Resultado
          selected_clean_columns:
          - date
          - NDVI_median
          - NDCI_median
          - B1_median
          - B2_median
          - B3_median
          - B4_median
          - B5_median
          - B6_median
          - B7_median
          - B8_median
          - B8A_median
          - B9_median
          - B11_median
          - B12_median
          selected_features:
          - B3_B4
          - NDVI_median
          - B5_B4
          - NDCI_median
          - B5B3_B2
          - B5_B2
          poly_degree: 3
        train:
          estimator_name: ridge
          estimators:
            ridge:
              params:
                alpha: 30
            xgboost:
              params:
                n_estimators: 1000
                learning_rate: 0.5
                max_depth: 16
                subsample: 0.8
                colsample_bytree: 0.9
                colsample_bylevel: 0.4
                scale_pos_weight: 85
            random_forest:
              params:
                max_features: sqrt
                min_samples_leaf: 1
                n_estimators: 615
                criterion: absolute_error
          model_path: models/model.joblib
          full_model_path: models/full_model.joblib
    outs:
    - path: data/predictions/predicted.csv
      md5: 79e4b3fa6bd8a3a072b1233e38d25b8c
      size: 10482
